#!/usr/bin/perl
use strict;

use QuizMaker;

#
# qzm-view_test
#
# Outputs a complete test ready to be processed with LaTeX.
#

# {{{ process arguments (@ARGV)

my $printanswers = 0;

# name of this program with out directory names
my $prog_name = (split /\//, $0)[-1];

my $printanswers_str = $printanswers ? "on" : "off" ;

my $usage = <<"USAGE";
  USAGE:
    $prog_name [options] <test name>

  OPTIONS:
    <option>           [<default value>] description

    --printanswers     [$printanswers_str] print the answers
USAGE


unless (@ARGV >= 1) {
    die "$usage\n";
}

# last argument should be <test name>
my $test_file = pop @ARGV;

# process remaining arguments
for (my $i = 0; $i < @ARGV; $i++) {
	my $arg = $ARGV[$i];
	if ($arg eq '--printanswers') {
		$printanswers = 1;
	} else {
		die "unkown argument '$arg'\n";
	}
}

# }}}

my $qzt = QuizMaker::Test->load_file($test_file)
	or die "unable to load test\n";

print "% This file was generated by $prog_name on " . `date -R` . "\n";

print <<'HEADER1';

%\documentclass{exam}            % w/ answers
\documentclass[noanswers]{exam}  % w/o answers

\usepackage{multicol}
\usepackage{ulem}
\usepackage{graphicx}
\usepackage{amsmath}

\parindent=0pt
%\usepackage{graphicx}

\begin{document}


HEADER1

print <<'HEADER2';
% choose one or the other,
% or leave configured by \documentclass
HEADER2
print '%' if (! $printanswers);
print '\printanswers' . "\n";
print '%' if ($printanswers);
print '\noprintanswers' . "\n";
print "\n";

my $class = $qzt->{'class'};
my $term = $qzt->{'term'};
my $title = $qzt->{'title'};
# be sure to double the escapes with double quotes!
print <<"HEADER2";

\\begin{tabular}{l r}
Name: \\uline{\\hspace{200pt}} \\hspace{160pt} & $class \\\\
      & $term \\\\
      & $title \\\\
\\end{tabular}

HEADER2

print '
\vspace{10pt}

';

print $qzt->{'instructions'};

print '
\vspace{5pt}
';

print '
\begin{questions}
';

my @problems = @{$qzt->{problems}};

for (my $i = 0; $i < @problems; $i++) {
	#my $n = $i + 1;  # problem number
	my $qzp = $problems[$i];

	if ($qzp eq '\pagebreak') {
		print "\n\\pagebreak\n";
		next;
	}

	print "\n\\question ";
	#print "$n.)  ";
	print $qzp->{question};

	print "\n";
	print '\vspace*{' . $qzp->{workspace} . '}';
	print "\n";

	print "\n\\begin{solution}\n";
	print $qzp->{answer};
	print "\n\\end{solution}\n";
}

print '
\end{questions}

\end{document}
';


#!/usr/bin/perl
use strict;

use QuizMaker;

#
# qzm-view_test
#
# Outputs a complete test ready to be processed with LaTeX.
#

# {{{ process arguments (@ARGV)

my $printanswers = 0;

# name of this program with out directory names
my $prog_name = (split /\//, $0)[-1];

my $printanswers_str = $printanswers ? "on" : "off" ;

my $usage = <<"USAGE";
  USAGE:
    $prog_name [options] <test name>

  OPTIONS:
    <option>           [<default value>] description

    --printanswers     [$printanswers_str] print the answers
USAGE


unless (@ARGV >= 1) {
    die "$usage\n";
}

# last argument should be <test name>
my $test_file = pop @ARGV;

# process remaining arguments
for (my $i = 0; $i < @ARGV; $i++) {
	my $arg = $ARGV[$i];
	if ($arg eq '--printanswers') {
		$printanswers = 1;
	} else {
		die "unkown argument '$arg'\n";
	}
}

# }}}

my $qzt = QuizMaker::Test->load_file($test_file)
	or die "unable to load test\n";

print "% This file was generated by $prog_name on " . `date -R` . "\n";

print <<'HEADER1';

%\documentclass{exam}            % w/ answers
\documentclass[noanswers]{exam}  % w/o answers

\usepackage{multicol}
\usepackage{ulem}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{enumerate}

\parindent=0pt
%\usepackage{graphicx}

\begin{document}


HEADER1

print <<'HEADER2';
% choose one or the other,
% or leave configured by \documentclass
HEADER2
print '%' if (! $printanswers);
print '\printanswers' . "\n";
print '%' if ($printanswers);
print '\noprintanswers' . "\n";
print "\n";

my $class = $qzt->{'class'};
my $term = $qzt->{'term'};
my $title = $qzt->{'title'};
# be sure to double the escapes with double quotes!
print <<"HEADER2";

\\begin{tabular}{l r}
Name: \\uline{\\hspace{200pt}} \\hspace{160pt} & $class \\\\
      & $term \\\\
      & $title \\\\
\\end{tabular}

HEADER2

print '
\vspace{10pt}

';

print $qzt->{'instructions'};

print '
\vspace{5pt}
';

print '
\begin{questions}
';

my @problems = @{$qzt->{problems}};

for (my $i = 0; $i < @problems; $i++) {
	#my $n = $i + 1;  # problem number
	my $qzp = $problems[$i];
	my $workspace = $qzp->{workspace};

	# Add a pagebreak between problems if requested
	if ($qzp eq '\pagebreak') {
		#print "\n\\pagebreak\n";  # DISABLED
		next;
	}

	print "\n";

	# Add Vim folds to make the .tex source easier to navigate.
	print "% {{{ Q" . ($i + 1) . "\n";

	print "\\begin{samepage}\n";
	print "\n";

	# Add the location where the problem file was sourced from
	print "% problem file: '" . $qzp->{file} . "'\n";

	print "\\question ";
	#print "$n.)  ";

	# print the question
	# And also fix the }}} in equations which conflict with Vim folds
	my $tmp = $qzp->{question};	
	$tmp =~ s/}}}/} } }/g;
	print $tmp;

	if ($printanswers) {
		# leave out the work space if answers are being included
	} elsif ($workspace ne '0' and $workspace ne 'wholepage') {
		print "\n";
		print '\vspace*{' . $workspace . '}';
		print "\n";
	}

	print "\n\\end{samepage}\n";

	# If the problem workspace needs the 'wholepage' 
	# do this by adding a pagebreak.
	# If a preceeding page break is desired this can be accomplished
	# by using \pagebreak as a problem in the test definition (see above).
	if ($workspace eq 'wholepage') {
		print '\pagebreak' . "\n";
	}

	print "\n";

	# The answer is always in the .tex output, but it
	# can be configured in that file whether to display
	# them or not.
	print "% {{{ solution\n";
	print "\\begin{solution}\n";

	# print the anser
	# And also fix the }}} in equations which conflict with Vim folds
	my $tmp = $qzp->{answer};	
	$tmp =~ s/}}}/} } }/g;
	print $tmp;

	print "\n\\end{solution}\n";

	print "% }}}\n";  # END solution fold
	print "% }}}\n";  # END question fold
}

print '
\end{questions}

\end{document}
';

#!/usr/bin/perl
use strict;

use DBI;
use QuizMaker;

my $dbname = "quizmaker";

my $dbh = DBI->connect("dbi:Pg:dbname=$dbname")
	or exit 1;

my $test_id;

my @open_test_ids = @{get_open_tests($dbh)};
my @all_test_ids = @{get_all_tests($dbh)};
my @done_test_ids;

# print non-open tests
print_test_header();

foreach my $test_id_x (@all_test_ids) {
	if (! (grep { $_ == $test_id_x } @open_test_ids)) {
		print_test($dbh, $test_id_x);
		push @done_test_ids, $test_id_x;
	}
}
# list tests

if (@done_test_ids) {
	while (1) {
		print "Which test do you want to score? ";
		my $test_id_x = <STDIN>;
		chomp($test_id_x);

		if (grep { $test_id_x == $_ } @done_test_ids) {
			print "Found!\n";
			$test_id = $test_id_x;
			last;
		} else {
			print "Invalid choice.\n";
		}
	}
} else {
	print "No other tests found.\n";
}

my $test_start_time;
my $sql1 =
	"SELECT max(test_start_time) FROM TestProblemResults
		WHERE test_id = ?
		AND correct_p IS NULL ;";
my $sth1 = $dbh->prepare($sql1);
$sth1->execute($test_id);
($test_start_time) = $sth1->fetchrow_array();

my @problem_id_nums;
my $sql2 =
	"SELECT problem_num, problem_id FROM TestProblems
		WHERE test_id = ?
		ORDER BY problem_num ;";
my $sth2 = $dbh->prepare($sql2);
my $rv = $sth2->execute($test_id);
my $res2_ref = $sth2->fetchall_arrayref();
@problem_id_nums = map { [$_->[0], $_->[1]] } @$res2_ref;

my $sql3 =
	"UPDATE TestProblemResults SET correct_p = ?
		WHERE test_id = ?
		AND   test_start_time = ?
		AND   problem_id = ? ;";
my $sth3 = $dbh->prepare($sql3);

print "Enter 1 or k for correct, 0 or j for wrong\n";
foreach my $problem_id_num (@problem_id_nums) {
	my ($problem_num, $problem_id) = @$problem_id_num;

	print "P: $problem_num? ";
	while (1) {
		my $ans = <STDIN>;
		chomp($ans);

		if ($ans =~ /^[1k]{1}$/) {
			$ans = 't';
		} elsif ($ans =~ /^[0j]{1}$/) {
			$ans = 'f';
		} else {
			print "Invalid entry, please try again.\n";
			next;
		}

		my $rv = $sth3->execute($ans, $test_id, $test_start_time, $problem_id);

		last;
	}

}
